window.Glyphbase = window.Glyphbase || {};
window.Glyphbase.Maps = (function() {

  var map;
  var lastSelectedMarker;

  function initialize(domElem, mapZoom, mapCenter) {

    var zoom            = mapZoom || 16;
    var center          = mapCenter || new google.maps.LatLng(37.794108,-122.39511);
    var mapContainer    = domElem || 'map-canvas';
    var mapCanvas       = document.getElementById(mapContainer);
   
    var mapOptions = {
        disableDefaultUI: true,
        scrollwheel: false,
        draggable: false,
        center: center,
        zoom: zoom,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        styles: [
          {
            "elementType": "labels",
            "stylers": [
              { "visibility": "off" }
            ]
          },{
            "featureType": "administrative",
            "elementType": "labels",
            "stylers": [
              { "visibility": "on" }
            ]
          },{
            "featureType": "road",
            "elementType": "labels",
            "stylers": [
              { "visibility": "on" }
            ]
          },{
            "featureType": "transit",
            "elementType": "labels",
            "stylers": [
              { "visibility": "on" }
            ]
          },{
            "featureType": "poi.park",
            "stylers": [
              { "hue": "#22ff00" },
              { "saturation": -48 },
              { "lightness": -10 }
            ]
          }
        ]
    };

    map = new google.maps.Map(mapCanvas, mapOptions);

  }

  function addMarker(latitude, longitude, title) {
    var markerTitle = title || "Glyph";
    var marker = new google.maps.Marker({
        map:       map,
        animation: google.maps.Animation.DROP,
        title:     markerTitle,
        position:  new google.maps.LatLng(latitude, longitude),
        icon: "<%= asset_path 'mapLocation.svg' %>",
        optimized: false 
    });
    return marker;
  };

  function buildInfoWindow(glyph) {
    console.log(glyph);
    var template="";
        template += "<a class=\"map-link\" href=\"/glyphs/" + glyph.id + "\">";
        template += "<aside class=\"map-itemImage\"><\/aside>";
        template += "<section class=\"map-itemContent\">";
        template += "<span class=\"map-itemTitle\">" + glyph.title + "<\/span>";
        // template += "<span class=\"map-itemCreator\">" + "author" + "<\/span>";
        template += "<span class=\"map-itemInfo\">" + glyph.tagline + "<\/span>";
        template += "<\/section>";
        template += "<\/a>";
    return template;

  };

  function addInfoWindowToMarker(marker, glyph) {
    var infoBubble = new InfoBubble({
      map: map,
      content: buildInfoWindow(glyph),
      position: marker.getPosition(),
      shadowStyle: 1,
      padding: 0,
      backgroundColor: '#fff',
      borderRadius: 5,
      arrowSize: 15,
      borderWidth: 1,
      borderColor: '#ccc',
      disableAutoPan: false,
      hideCloseButton: false,
      maxWidth: 350,
      minWidth: 350,
      maxHeight: 110,
      minHeight: 110,
      arrowPosition: 50,
      backgroundClassName: 'transparent',
      arrowStyle: 0
    });
    google.maps.event.addListener(marker, 'click', function() {
        if(lastSelectedMarker) lastSelectedMarker.close(); // Close last marker if one was opened
        infoBubble.open(map, this);
        lastSelectedMarker = infoBubble;
    });
  };

  function centerOnMarker(marker) {
    map.setCenter(marker.getPosition());
  };

  return {
    initialize:     initialize,
    addMarker:      addMarker,
    centerOnMarker: centerOnMarker,
    addInfoWindowToMarker: addInfoWindowToMarker
  };
})();